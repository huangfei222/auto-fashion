# AI_Global_Factory_TurboUltra.py
import os
import sys
from pathlib import Path
from multiprocessing import cpu_count
from concurrent.futures import ProcessPoolExecutor
from time import perf_counter

try:
    from PIL import Image, ImageEnhance
except ImportError:
    print("è‡ªåŠ¨å®‰è£…ä¾èµ–...")
    os.system(f"{sys.executable} -m pip install pillow==10.3.0 -q")
    from PIL import Image, ImageEnhance

class TurboFactory:
    VERSION = "TurboUltra 8.0"
    
    def __init__(self):
        self.base_dir = Path("D:/AI_System")
        self.templates = {}
        self._init_system()
        self._preload_assets()
        
    def _init_system(self):
        """é—ªç”µåˆå§‹åŒ–ç³»ç»Ÿ"""
        products = ["æ‰‹æœºå£³", "Tæ¤", "å£çº¸", "æµ·æŠ¥"]
        platforms = ["Amazon", "Etsy", "Redbubble", "Shopify"]
        
        # å¹¶è¡Œåˆ›å»ºç›®å½•ç»“æ„
        with ProcessPoolExecutor() as exec:
            for product in products:
                exec.submit((self.base_dir/"data"/"raw"/product).mkdir, parents=True, exist_ok=True)
                for platform in platforms:
                    exec.submit((self.base_dir/"output"/platform/product).mkdir, parents=True, exist_ok=True)
        
        # ç”Ÿæˆæ¨¡æ¿æ–‡ä»¶
        self._gen_template("æ‰‹æœºå£³", 2000, 2000)
        self._gen_template("Tæ¤", 4500, 5400)
        self._gen_template("æµ·æŠ¥", 6000, 9000)
        self._gen_template("å£çº¸", 3840, 2160)

    def _preload_assets(self):
        """é¢„åŠ è½½æ‰€æœ‰æ¨¡æ¿"""
        template_map = {
            "æ‰‹æœºå£³": (2000, 2000),
            "Tæ¤": (4500, 5400),
            "æµ·æŠ¥": (6000, 9000)
        }
        for name, size in template_map.items():
            path = self.base_dir/"templates"/f"{name}_template.png"
            if not path.exists():
                Image.new("RGBA", size, (255,255,255,0)).save(path)
            self.templates[name] = Image.open(path).convert("RGBA")

    def _gen_template(self, product, w, h):
        """ç”Ÿæˆäº§å“æ¨¡æ¿"""
        path = self.base_dir/"templates"/f"{product}_template.png"
        if not path.exists():
            Image.new("RGBA", (w, h), (255,255,255,0)).save(path)

    def _turbo_enhance(self, img, min_size):
        """ä¿®å¤æ‹¬å·é—®é¢˜çš„å¢å¼ºå¼•æ“"""
        if img.width < min_size[0]:
            new_width = min_size[0]
            new_height = int(img.height * (min_size[0] / img.width))
            img = img.resize(
                (new_width, new_height),  # æ­£ç¡®é—­åˆæ‹¬å·
                Image.Resampling.LANCZOS
            )
        return ImageEnhance.Sharpness(img).enhance(1.5)

    def _hyper_process(self, product_type, processor, min_size):
        """é‡å­å¤„ç†æµæ°´çº¿"""
        input_dir = self.base_dir/"data"/"raw"/product_type
        files = [f for f in input_dir.glob("*.png") if f.is_file()]
        
        with ProcessPoolExecutor(max_workers=cpu_count()*2) as exec:
            futures = [exec.submit(self._process_single, f, product_type, processor, min_size) for f in files]
            for future in futures:
                try:
                    future.result(timeout=15)
                except Exception as e:
                    print(f"âš¡ æé€Ÿè·³è¿‡ï¼š{str(e)}")

    def _process_single(self, img_file, product_type, processor, min_size):
        """å•æ–‡ä»¶é—ªç”µå¤„ç†"""
        try:
            t_start = perf_counter()
            with Image.open(img_file) as img:
                result = processor(img.convert("RGBA"), min_size)
                self._save_all_platforms(result, product_type, img_file.stem)
            print(f"âœ… {product_type}ç”Ÿäº§æˆåŠŸ | è€—æ—¶ï¼š{perf_counter()-t_start:.2f}s | æ–‡ä»¶ï¼š{img_file.name}")
        except Exception as e:
            print(f"ğŸ”¥ å¼‚å¸¸è·³è¿‡ï¼š{img_file.name} | åŸå› ï¼š{str(e)}")

    # ========== æ ¸å¿ƒç”Ÿäº§çº¿ ==========
    def phone_processor(self, img, min_size):
        enhanced = self._turbo_enhance(img, min_size)
        template = self.templates["æ‰‹æœºå£³"].copy()
        x = (template.width - enhanced.width) // 2
        y = (template.height - enhanced.height) // 2
        template.alpha_composite(enhanced, (x, y))
        return template

    def tshirt_processor(self, img, min_size):
        enhanced = self._turbo_enhance(img, min_size)
        template = self.templates["Tæ¤"].copy()
        x = (template.width - enhanced.width) // 2
        y = int(template.height * 0.3)
        template.alpha_composite(enhanced, (x, y))
        return template

    def poster_processor(self, img, min_size):
        enhanced = self._turbo_enhance(img, min_size)
        template = self.templates["æµ·æŠ¥"].copy()
        x = (template.width - enhanced.width) // 2
        y = (template.height - enhanced.height) // 2
        template.alpha_composite(enhanced, (x, y))
        return template

    def wallpaper_processor(self, img, min_size):
        enhanced = self._turbo_enhance(img, min_size)
        return {
            "æ¨ªç‰ˆ": enhanced.crop((0, 0, 3840, 2160)),
            "ç«–ç‰ˆ": enhanced.crop((0, 0, 2160, 3840))
        }

    def _save_all_platforms(self, img_data, category, base_name):
        """å…¨å¹³å°å­˜å‚¨ç³»ç»Ÿ"""
        try:
            # Amazon
            self._save_amazon(img_data, category, base_name)
            # Etsy
            self._save_etsy(img_data, category, base_name)
            # Redbubble
            self._save_redbubble(img_data, category, base_name)
            # Shopify
            self._save_shopify(img_data, category, base_name)
        except Exception as e:
            print(f"ğŸ’¾ å­˜å‚¨å¼‚å¸¸è·³è¿‡ï¼š{str(e)}")

    def _save_amazon(self, img, category, name):
        """Amazonä¸“ä¸šå­˜å‚¨"""
        if isinstance(img, dict):
            for size, img_part in img.items():
                bg = Image.new("RGB", img_part.size, (255,255,255))
                bg.paste(img_part, mask=img_part.split()[3])
                bg.convert("CMYK").save(
                    self.base_dir/"output"/"Amazon"/category/f"{name}_{size}.tif",
                    "TIFF", dpi=(300,300), compression="jpeg")
        else:
            bg = Image.new("RGB", img.size, (255,255,255))
            bg.paste(img, mask=img.split()[3])
            bg.convert("CMYK").save(
                self.base_dir/"output"/"Amazon"/category/f"{name}.tif",
                "TIFF", dpi=(300,300), compression="jpeg")

    def _save_etsy(self, img, category, name):
        """Etsyä¼˜åŒ–å­˜å‚¨"""
        def _optimize(img_part):
            img_rgb = img_part.convert("RGB")
            if max(img_rgb.size) > 3000:
                return img_rgb.resize((3000,3000), Image.Resampling.LANCZOS)
            return img_rgb
            
        if isinstance(img, dict):
            for size, img_part in img.items():
                _optimize(img_part).save(
                    self.base_dir/"output"/"Etsy"/category/f"{name}_{size}.jpg",
                    "JPEG", quality=90, optimize=True)
        else:
            _optimize(img).save(
                self.base_dir/"output"/"Etsy"/category/f"{name}.jpg",
                "JPEG", quality=90, optimize=True)

    def _save_redbubble(self, img, category, name):
        """Redbubbleé€æ˜å­˜å‚¨"""
        if isinstance(img, dict):
            for size, img_part in img.items():
                img_part.save(
                    self.base_dir/"output"/"Redbubble"/category/f"{name}_{size}.png",
                    "PNG", optimize=True)
        else:
            img.save(
                self.base_dir/"output"/"Redbubble"/category/f"{name}.png",
                "PNG", optimize=True)

    def _save_shopify(self, img, category, name):
        """ShopifyåŒæ ¼å¼å­˜å‚¨"""
        def _save_dual(img_part, path):
            img_part.save(path.with_suffix(".webp"), "WEBP", quality=95, method=6)
            img_part.save(path.with_suffix(".png"), "PNG", optimize=True)
            
        if isinstance(img, dict):
            for size, img_part in img.items():
                _save_dual(img_part, self.base_dir/"output"/"Shopify"/category/f"{name}_{size}")
        else:
            _save_dual(img, self.base_dir/"output"/"Shopify"/category/name)

    def launch(self):
        """ä¸€é”®å¯åŠ¨"""
        print(f"\n{'='*40}\nğŸš€ é‡å­ç”µå•†å·¥å‚ {self.VERSION}\n{'='*40}")
        t_start = perf_counter()
        
        try:
            with ProcessPoolExecutor(max_workers=4) as exec:
                exec.submit(self._hyper_process, "æ‰‹æœºå£³", self.phone_processor, (1800,1800))
                exec.submit(self._hyper_process, "Tæ¤", self.tshirt_processor, (3500,3500))
                exec.submit(self._hyper_process, "æµ·æŠ¥", self.poster_processor, (3000,4500))
                exec.submit(self._hyper_process, "å£çº¸", self.wallpaper_processor, (4096,4096))
        except KeyboardInterrupt:
            print("\nğŸ›‘ ç”¨æˆ·ç»ˆæ­¢æ“ä½œ")
        finally:
            print(f"\nğŸŒŸ ç”Ÿäº§å®Œæˆ | æ€»è€—æ—¶ï¼š{perf_counter()-t_start:.2f}ç§’")
            print("è¾“å‡ºç›®å½•ï¼šD:/AI_System/output")

if __name__ == "__main__":
    TurboFactory().launch()