"""
å…¨è‡ªåŠ¨ç”µå•†ç»ˆæç‰ˆ v5.0
"""
import os
import shutil
import time
from pathlib import Path
from PIL import Image
import undetected_chromedriver as uc

# ----------------- é…ç½®åŒº -----------------
WORKSPACE = Path("D:/AI_System")
CHROME_PROFILE = WORKSPACE / "chrome_profile"
CHROME_VERSION = 134  # å¿…é¡»ä¸chrome://versionä¸­çš„ä¸»ç‰ˆæœ¬ä¸€è‡´

# ----------------- æ ¸å¿ƒç±» -----------------
class AutoShop:
    def __init__(self):
        self.driver = None
        
    def _get_chrome_options(self):
        """ä¿®å¤æ‰€æœ‰å·²çŸ¥é€‰é¡¹é—®é¢˜"""
        options = uc.ChromeOptions()
        options.add_argument("--disable-blink-features=AutomationControlled")
        options.add_argument("--no-first-run")
        options.add_argument("--no-service-autorun")
        return options
        
    def init_browser(self):
        """ç»ˆææµè§ˆå™¨åˆå§‹åŒ–"""
        self.driver = uc.Chrome(
            user_data_dir=str(CHROME_PROFILE),
            options=self._get_chrome_options(),
            version_main=CHROME_VERSION,
            driver_executable_path=None,  # è‡ªåŠ¨æŸ¥æ‰¾é©±åŠ¨
        )
        
    def generate_test_image(self):
        """ç”ŸæˆéªŒè¯å›¾ç‰‡"""
        test_img = WORKSPACE / "generated" / "final_test.png"
        Image.new('RGB', (1242, 2688), (255,0,0)).save(test_img)  # æ‰‹æœºå£³æ ‡å‡†å°ºå¯¸
        return test_img
    
    def test_run(self):
        """ç»ˆæéªŒè¯æµç¨‹"""
        print("ğŸŸ¢ å¯åŠ¨ç»ˆæéªŒè¯...")
        try:
            self.init_browser()
            print(f"âœ… æµè§ˆå™¨å·²å¯åŠ¨ï¼Œç‰ˆæœ¬ï¼š{CHROME_VERSION}")
            
            img_path = self.generate_test_image()
            print(f"âœ… æµ‹è¯•å›¾ç‰‡ç”Ÿæˆäºï¼š{img_path}")
            
            dest = WORKSPACE / "published" / "Local_Amazon" / "red"
            dest.mkdir(parents=True, exist_ok=True)
            shutil.copy(img_path, dest / img_path.name)
            
            print("ğŸ”¥ éªŒè¯æˆåŠŸï¼5ç§’åå…³é—­æµè§ˆå™¨...")
            time.sleep(5)
        finally:
            self.driver.quit()

if __name__ == "__main__":
    AutoShop().test_run()