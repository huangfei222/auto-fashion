# mj_2025_final.py
import os
import time
import logging
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.support.ui import WebDriverWait
from undetected_chromedriver import Chrome, ChromeOptions

# ===================== ç²¾å‡†é…ç½® =====================
CONFIG = {
    "server_id": "1344917223021744221",
    "channel_id": "1344921569541095446",
    "prompt": "/imagine èµ›åšæœ‹å…‹é£æ ¼æ‰‹æœºå£³ --v 6 --ar 18:32",
    "download_path": r"D:\AI_System\Downloads",
    "user_data_dir": r"C:\Users\Administrator\AppData\Local\Google\Chrome\User Data",
    "chrome_bin": r"C:\Program Files\Google\Chrome\Application\chrome.exe"
}
# =================================================

logging.basicConfig(
    level=logging.INFO,
    format="[%(asctime)s][%(levelname)s] %(message)s",
    handlers=[
        logging.FileHandler("D:/AI_System/operation.log", encoding="utf-8"),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

class DiscordBot2025:
    def __init__(self):
        self.driver = None
        self._clean_processes()

    def _clean_processes(self):
        os.system("taskkill /F /IM chrome.exe /T 2>nul")
        os.system("taskkill /F /IM chromedriver.exe /T 2>nul")
        time.sleep(2)
        logger.info("âœ… è¿›ç¨‹æ¸…ç†å®Œæˆ")

    def _init_driver(self):
        options = ChromeOptions()
        options.add_argument(f"--user-data-dir={CONFIG['user_data_dir']}")
        options.add_argument("--disable-blink-features=AutomationControlled")
        options.binary_location = CONFIG["chrome_bin"]
        
        prefs = {"download.default_directory": CONFIG["download_path"]}
        options.add_experimental_option("prefs", prefs)

        try:
            self.driver = Chrome(
                options=options,
                headless=False,
                version_main=135,
                driver_executable_path=r"D:\AI_System\venv\Scripts\chromedriver.exe"
            )
            logger.info("ğŸš€ æµè§ˆå™¨å¯åŠ¨æˆåŠŸ")
            return True
        except Exception as e:
            logger.error(f"âŒ æµè§ˆå™¨å¯åŠ¨å¤±è´¥: {str(e)}")
            return False

    def _select_server(self):
        """ç²¾å‡†é€‰æ‹©æœåŠ¡å™¨"""
        server_selector = f'div[data-list-item-id="guildsnav___{CONFIG["server_id"]}"]'
        server = WebDriverWait(self.driver, 30).until(
            EC.element_to_be_clickable((By.CSS_SELECTOR, server_selector))
        )
        server.click()
        logger.info("ğŸ”— æœåŠ¡å™¨é€‰æ‹©æˆåŠŸ")

    def _select_channel(self):
        """ç²¾å‡†é€‰æ‹©é¢‘é“"""
        channel_xpath = '//div[contains(@class, "name__2ea32") and text()="ç”Ÿæˆå›¾ç‰‡"]'
        channel = WebDriverWait(self.driver, 30).until(
            EC.element_to_be_clickable((By.XPATH, channel_xpath)))
        channel.click()
        logger.info("ğŸ“Œ é¢‘é“é€‰æ‹©æˆåŠŸ")

    def _input_prompt(self):
        """ç²¾å‡†è¾“å…¥æç¤ºè¯"""
        input_box = WebDriverWait(self.driver, 30).until(
            EC.element_to_be_clickable((By.CSS_SELECTOR, 'div[data-slate-node="element"]')))
        
        # æ¨¡æ‹ŸçœŸå®è¾“å…¥
        self.driver.execute_script("arguments[0].click();", input_box)
        for char in CONFIG["prompt"]:
            input_box.send_keys(char)
            time.sleep(0.08 + (ord(char)%3)*0.02)  # éšæœºè¾“å…¥é—´éš”
        input_box.send_keys(Keys.ENTER)
        logger.info("âŒ¨ æç¤ºè¯è¾“å…¥å®Œæˆ")

    def _wait_generation(self):
        """ç²¾å‡†ç­‰å¾…ç”Ÿæˆ"""
        img_selector = 'a[data-role="img"][href*="attachments"]'
        WebDriverWait(self.driver, 600).until(
            EC.presence_of_element_located((By.CSS_SELECTOR, img_selector)))
        logger.info("ğŸ–¼ï¸ å›¾ç‰‡ç”Ÿæˆç¡®è®¤")

    def execute(self):
        try:
            if not self._init_driver():
                return

            self.driver.get("https://discord.com/channels/@me")
            time.sleep(3)
            
            # é€‰æ‹©æœåŠ¡å™¨
            self._select_server()
            
            # é€‰æ‹©é¢‘é“
            self._select_channel()
            
            # è¾“å…¥æç¤ºè¯
            self._input_prompt()
            
            # ç­‰å¾…ç”Ÿæˆ
            self._wait_generation()
            
            logger.info("âœ… æ‰€æœ‰æ“ä½œå·²å®Œæˆ")

        except Exception as e:
            logger.error(f"ğŸ’¥ æµç¨‹ä¸­æ–­: {str(e)}")
            self._save_debug()
        finally:
            if self.driver:
                self.driver.quit()
                logger.info("ğŸ›‘ æµè§ˆå™¨å·²å…³é—­")

    def _save_debug(self):
        timestamp = time.strftime("%Y%m%d_%H%M%S")
        try:
            self.driver.save_screenshot(f"D:/AI_System/debug_{timestamp}.png")
            logger.info(f"ğŸ”§ è°ƒè¯•æˆªå›¾å·²ä¿å­˜: debug_{timestamp}.png")
        except Exception as e:
            logger.error(f"âš  æˆªå›¾å¤±è´¥: {str(e)}")

if __name__ == "__main__":
    os.makedirs(CONFIG["download_path"], exist_ok=True)
    bot = DiscordBot2025()
    bot.execute()