# mj_auto_fixed.py
import os
import time
import logging
from selenium.webdriver.common.by import By
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.support.ui import WebDriverWait
from undetected_chromedriver import Chrome, ChromeOptions

# ===================== é…ç½®åŒº =====================
CONFIG = {
    "server_id": "1344917223021744221",
    "channel_id": "1344921569541095446",
    "server_icon_src": "https://cdn.discordapp.com/icons/1344917223021744221/",
    "prompt": "/imagine èµ›åšæœ‹å…‹é£æ ¼æ‰‹æœºå£³ --v 5 --ar 9:16",
    "download_path": r"D:\AI_System\Downloads"
}
# ================================================

logging.basicConfig(
    level=logging.INFO,
    format="[%(asctime)s][%(levelname)s] %(message)s",
    handlers=[
        logging.FileHandler("D:/AI_System/operation.log", encoding="utf-8"),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

class DiscordBotPro:
    def __init__(self):
        self.driver = None
        self._clean_processes()

    def _clean_processes(self):
        os.system("taskkill /F /IM chrome.exe /T 2>nul")
        os.system("taskkill /F /IM chromedriver.exe /T 2>nul")
        time.sleep(2)
        logger.info("âœ… è¿›ç¨‹æ¸…ç†å®Œæˆ")

    def _init_driver(self):
        options = ChromeOptions()
        options.add_argument(r"--user-data-dir=C:\Users\Administrator\AppData\Local\Google\Chrome\User Data")
        options.add_argument("--disable-blink-features=AutomationControlled")
        
        try:
            driver = Chrome(
                options=options,
                headless=False,
                version_main=134,
                driver_executable_path=r"D:\AI_System\venv\Scripts\chromedriver.exe"
            )
            logger.info("ğŸš€ æµè§ˆå™¨å¯åŠ¨æˆåŠŸ")
            return driver
        except Exception as e:
            logger.error(f"âŒ æµè§ˆå™¨å¯åŠ¨å¤±è´¥: {str(e)}")
            return None

    def _smart_wait(self, selector, by=By.CSS_SELECTOR, timeout=30):
        """å¢å¼ºå‹å…ƒç´ å®šä½"""
        for attempt in range(3):
            try:
                element = WebDriverWait(self.driver, timeout).until(
                    EC.element_to_be_clickable((by, selector))
                )
                self._highlight(element)
                return element
            except:
                if attempt == 2:
                    self._save_debug()
                    raise
                logger.warning(f"å®šä½é‡è¯• {attempt+1}/3")
                time.sleep(2)

    def _highlight(self, element):
        """å¯è§†åŒ–æ ‡è®°å…ƒç´ """
        self.driver.execute_script(
            "arguments[0].style.outline='3px solid #00ff00'",
            element
        )
        time.sleep(0.5)

    def _save_debug(self):
        """ä¿å­˜è°ƒè¯•ä¿¡æ¯"""
        timestamp = time.strftime("%Y%m%d_%H%M%S")
        try:
            if self.driver:
                self.driver.save_screenshot(f"D:/AI_System/debug_{timestamp}.png")
                with open(f"D:/AI_System/page_{timestamp}.html", "w", encoding="utf-8") as f:
                    f.write(self.driver.page_source)
            logger.info(f"ğŸ”§ è°ƒè¯•æ–‡ä»¶å·²ä¿å­˜: debug_{timestamp}.*")
        except Exception as e:
            logger.error(f"âš  è°ƒè¯•ä¿å­˜å¤±è´¥: {str(e)}")

    def execute(self):
        try:
            self.driver = self._init_driver()
            if not self.driver:
                raise RuntimeError("æµè§ˆå™¨åˆå§‹åŒ–å¤±è´¥")

            # è®¿é—®ç›®æ ‡é¢‘é“
            self.driver.get(f"https://discord.com/channels/{CONFIG['server_id']}/{CONFIG['channel_id']}")
            logger.info("ğŸŒ æ­£åœ¨åŠ è½½é¢‘é“é¡µé¢...")

            # å®šä½æœåŠ¡å™¨
            icon_selector = f'img[src^="{CONFIG["server_icon_src"]}"]'
            icon = self._smart_wait(icon_selector, timeout=60)
            server = self.driver.execute_script(
                "return arguments[0].closest('div[role=\"treeitem\"]')", 
                icon
            )
            self.driver.execute_script("arguments[0].click();", server)
            logger.info("ğŸ”— æœåŠ¡å™¨å®šä½æˆåŠŸ")

            # è¾“å…¥æç¤ºè¯ï¼ˆå…³é”®ä¿®æ”¹ï¼‰
            input_box = self._smart_wait(
                '[role="textbox"][aria-label*="æ¶ˆæ¯"]:not([disabled])',
                timeout=60
            )
            input_box.send_keys(CONFIG["prompt"])
            logger.info("âŒ¨ æç¤ºè¯è¾“å…¥å®Œæˆ")

            # æäº¤ç”Ÿæˆï¼ˆå¢å¼ºç­‰å¾…ï¼‰
            WebDriverWait(self.driver, 30).until(
                lambda d: "disabled" not in d.find_element(
                    By.CSS_SELECTOR, 
                    'button[type="submit"]'
                ).get_attribute("class")
            )
            submit_btn = self._smart_wait('button[type="submit"]')
            submit_btn.click()
            logger.info("ğŸš€ å·²æäº¤ç”Ÿæˆè¯·æ±‚")

            # ç­‰å¾…ç»“æœ
            self._smart_wait('div[class*="upscaled"]', timeout=300)
            logger.info("ğŸ–¼ï¸ å›¾ç‰‡ç”Ÿæˆå®Œæˆ")

            # ä¸‹è½½æ“ä½œ
            download_btn = self._smart_wait('button[aria-label="ä¸‹è½½"]')
            download_btn.click()
            logger.info(f"ğŸ“¥ æ–‡ä»¶ä¿å­˜è‡³: {CONFIG['download_path']}")

        except Exception as e:
            logger.error(f"ğŸ’¥ æµç¨‹ä¸­æ–­: {str(e)}")
            self._save_debug()
        finally:
            if self.driver:
                self.driver.quit()
                logger.info("ğŸ›‘ æµè§ˆå™¨å·²å…³é—­")

if __name__ == "__main__":
    os.makedirs(CONFIG["download_path"], exist_ok=True)
    bot = DiscordBotPro()
    bot.execute()